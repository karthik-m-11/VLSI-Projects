# scripts/Makefile
# Simulator: Questa/ModelSim
SIM        ?= questa
TOP        ?= tb_top
FILES      ?= filelist.f
WORK       ?= work
OUT_DIR    ?= .
LOG_DIR    ?= ../logs
WAVE_DIR   ?= ../waves
REP_DIR    ?= ../reports

# Test control
TEST       ?= test_sanity
SEED       ?= auto
UVM_VERB   ?= UVM_MEDIUM

# Coverage control
COV        ?= 1
COV_OUT    ?= $(REP_DIR)/$(TEST).ucdb

# Wave dump control (VCD via DUMP_WAVES)
DUMP_WAVES ?= 0

# Tool alias
VLOG       = vlog
VSIM       = vsim

.PHONY: all compile run clean dirs

all: dirs compile run

dirs:
	@mkdir -p $(LOG_DIR) $(WAVE_DIR) $(REP_DIR)

compile:
	$(VLOG) -work $(WORK) -sv -f $(FILES)

# Run a single test
run:
	$(VSIM) -c $(TOP) \
		-do "run.tcl $(TEST) $(SEED) $(COV) $(COV_OUT)" \
		-voptargs="+acc" \
		+UVM_VERBOSITY=$(UVM_VERB) \
		$(if $(filter $(DUMP_WAVES),1),+define+DUMP_WAVES) \
		-logfile $(LOG_DIR)/$(TEST).log

# Convenience target to specify test and seed:
# make test TEST=test_read SEED=123
test:
	$(MAKE) run TEST=$(TEST) SEED=$(SEED)

# Regression via Perl driver
regression:
	@perl run.pl regression.cfg

clean:
	@rm -rf $(WORK) transcript vsim.wlf $(LOG_DIR)/* $(WAVE_DIR)/* $(REP_DIR)/*.ucdb